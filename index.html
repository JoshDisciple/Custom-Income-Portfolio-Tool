<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Income Portfolio Tool</title>
  <!-- Google font for a modern look -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js for visualisations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
  /* CSS variables for theming: light and dark modes */
    :root {
      --bg-colour: #0e1525;
      --card-bg: #1e294a;
      --text-colour: #e4e8f2;
      --muted-text: #9baacd;
      --accent: #4cc9f0;
      --hover-bg: #2e3e66;
      --border-colour: #324877;
      --tooltip-bg: rgba(14, 21, 37, 0.95);
    --table-header-bg: #25304d;
    --table-header-text: #4cc9f0;
    }
    .light-mode {
      --bg-colour: #f5f7fa;
      --card-bg: #ffffff;
      --text-colour: #2a2a2a;
      --muted-text: #5f6a82;
      --accent: #0077b6;
      --hover-bg: #e8f0fe;
      --border-colour: #d1d9e6;
      --tooltip-bg: rgba(255, 255, 255, 0.95);
    --table-header-bg: #dbeafe;
    --table-header-text: #0077b6;
    }
    * { box-sizing: border-box; }
  /* Custom scrollbar for growth breakdown modal */
    /* Modal animation styles */
      .modal-fade {
        opacity: 0;
        transform: scale(0.92) translateY(32px);
        transition: opacity 0.45s cubic-bezier(.4,0,.2,1), transform 0.45s cubic-bezier(.4,0,.2,1);
        pointer-events: none;
        box-shadow: 0 16px 48px rgba(0,0,0,0.30);
        filter: blur(1.5px) brightness(0.95);
      }
      .modal-fade.show {
        opacity: 1;
        transform: scale(1) translateY(0);
        pointer-events: auto;
        filter: none;
      }
    .growth-breakdown-scroll {
      scrollbar-width: thin;
      scrollbar-color: var(--accent) var(--card-bg);
    }
    .growth-breakdown-scroll::-webkit-scrollbar {
      width: 10px;
      background: var(--card-bg);
      border-radius: 8px;
    }
    .growth-breakdown-scroll::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 8px;
      border: 2px solid var(--card-bg);
    }
    .growth-breakdown-scroll::-webkit-scrollbar-thumb:hover {
      background: var(--hover-bg);
    }
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-colour);
      color: var(--text-colour);
      line-height: 1.5;
      /* Add bottom padding to accommodate the sticky summary bar so the footer isn't hidden */
      padding-bottom: 4rem;
    }
    h1, h2, h3 {
      margin: 0 0 0.5rem;
      color: var(--accent);
    }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background-color: var(--bg-colour);
      border-bottom: 1px solid var(--border-colour);
      padding: 1rem;
      }

  /* Sticky table header for growth breakdown table */
      .growth-breakdown-scroll {
        max-height: 80vh;
        overflow-y: auto;
      }
      .sticky-th {
        position: sticky;
        top: 0;
        z-index: 2;
    background: var(--table-header-bg, #2e3e66);
    color: var(--table-header-text, var(--accent));
    box-shadow: 0 2px 4px rgba(0,0,0,0.04);
      }
      .sticky-th.second-row {
        top: 38px;
      }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    nav { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    nav a {
      padding: 0.4rem 0.8rem;
      border: 1px solid var(--accent);
      border-radius: 5px;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background 0.2s, color 0.2s;
    }
    nav a:hover {
      background-color: var(--accent);
      color: var(--card-bg);
    }
    .card {
      background-color: var(--card-bg);
      margin: 1.5rem;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transition: transform 0.2s, box-shadow 0.2s;
  scroll-margin-top: 116px; /* Further increased offset for sticky header */
    }
    .card:hover { transform: translateY(-4px); box-shadow: 0 6px 18px rgba(0,0,0,0.4); }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }
    th, td {
      padding: 0.6rem;
  border-bottom: 1px solid var(--border-colour);
  text-align: left;
  font-size: 0.9rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
    }
    th {
    background-color: var(--table-header-bg);
    color: var(--table-header-text);
    }
    tr:hover:not(thead tr) { background-color: var(--hover-bg); cursor: pointer; }
    .input-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.8rem;
      margin-top: 1rem;
    }
    .input-group {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 150px;
    }
    .input-group label { font-size: 0.8rem; color: var(--muted-text); margin-bottom: 0.25rem; }
    .styled-input, select {
      background-color: var(--card-bg);
      color: var(--text-colour);
      border: 1px solid var(--border-colour);
      padding: 0.5rem 0.75rem;
      border-radius: 6px;
      font-size: 0.9rem;
      /* Remove default arrow for custom styling */
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      position: relative;
  }

  /* Custom dropdown arrow */
  select.styled-input {
    background-image: url('data:image/svg+xml;utf8,<svg fill="%234cc9f0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.516 7.548a.75.75 0 0 1 1.06 0L10 10.972l3.424-3.424a.75.75 0 1 1 1.06 1.06l-3.954 3.954a.75.75 0 0 1-1.06 0L5.516 8.608a.75.75 0 0 1 0-1.06z"/></svg>');
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1.1em;
    padding-right: 2em;
  }
  .light-mode select.styled-input {
    background-image: url('data:image/svg+xml;utf8,<svg fill="%230077b6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.516 7.548a.75.75 0 0 1 1.06 0L10 10.972l3.424-3.424a.75.75 0 1 1 1.06 1.06l-3.954 3.954a.75.75 0 0 1-1.06 0L5.516 8.608a.75.75 0 0 1 0-1.06z"/></svg>');
  }

  /* Custom number input steppers */
  input[type="number"].styled-input::-webkit-inner-spin-button,
  input[type="number"].styled-input::-webkit-outer-spin-button {
    background: var(--card-bg);
    border-radius: 6px;
    width: 1.2em;
    height: 1.2em;
    border: none;
    box-shadow: none;
    color: var(--accent);
    -webkit-filter: brightness(1.2);
    filter: brightness(1.2);
  }
  input[type="number"].styled-input:focus::-webkit-inner-spin-button,
  input[type="number"].styled-input:focus::-webkit-outer-spin-button {
    background: var(--accent);
    color: var(--card-bg);
  }
  input[type="number"].styled-input::-webkit-input-placeholder {
    color: var(--muted-text);
  }
  /* Firefox */
  input[type="number"].styled-input {
    -moz-appearance: textfield;
  }
  input[type="number"].styled-input::-moz-inner-spin-button {
    background: var(--card-bg);
    color: var(--accent);
    border-radius: 6px;
  }
    }
    .styled-input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(76, 201, 240, 0.3);
    }
    .btn {
      padding: 0.5rem 0.9rem;
      border: 1px solid var(--accent);
      background-color: var(--card-bg);
      color: var(--accent);
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .btn:hover {
      background-color: var(--accent);
      color: var(--card-bg);
    }

    /* Make DRIP checkboxes more readable, especially in dark mode */
    input.drip-toggle {
      width: 16px;
      height: 16px;
      accent-color: var(--accent);
      cursor: pointer;
    }
    /* Tooltip styling */
    .tooltip {
  position: absolute;
  background-color: var(--tooltip-bg);
  color: var(--text-colour);
  padding: 0.65rem 0.85rem;
  border-radius: 10px;
  font-size: 0.85rem;
  max-width: 280px;
  pointer-events: none;
  z-index: 9999;
  border: 1px solid var(--accent);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
  white-space: pre-line;
  display: none;
  transition: opacity 0.15s ease, transform 0.15s ease;
}


    /* Glossary spacing for readability */
    #glossary dt, #glossaryModalInner dt {
      margin-top: 0.75rem;
      color: var(--accent);
      font-weight: 700;
      font-size: 1.05em;
    }
    #glossary dd {
      margin-left: 0;
      margin-bottom: 0.75rem;
      font-size: 0.88rem;
      color: var(--text-colour);
    }
    /* Sticky income summary bar */
    .income-summary {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      padding: 0.8rem 1rem;
      background-color: var(--card-bg);
      border-top: 1px solid var(--border-colour);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      z-index: 1000;
    }
    /* Pie chart container */
    #holdingsChartContainer { display: none; max-width: 600px; margin: 1rem auto; }
    @media (max-width: 600px) {
      .input-row { flex-direction: column; }
      .income-summary { flex-direction: column; gap: 0.5rem; align-items: flex-start; }
      #settingsDropdown { min-width: 160px; right: 0; left: auto; }
      section[style*="display: flex"] { flex-direction: column !important; }
    }

  /* Custom styling for the portfolio value slider */
  #accountSlider {
    /* Slider track styling */
    width: 100%;
    height: 8px;
    background: var(--hover-bg);
    border-radius: 4px;
    outline: none;
    cursor: pointer;
    -webkit-appearance: none;
    appearance: none;
  }
  /* WebKit track styling */
  #accountSlider::-webkit-slider-runnable-track {
    height: 8px;
    background: var(--hover-bg);
    border-radius: 4px;
  }
  /* Mozilla track styling */
  #accountSlider::-moz-range-track {
    height: 8px;
    background: var(--hover-bg);
    border-radius: 4px;
  }
  #accountSlider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px;
    height: 16px;
    background: var(--accent);
    border-radius: 50%;
    border: none;
    cursor: pointer;
    box-shadow: 0 0 2px rgba(0,0,0,0.4);
  }
  #accountSlider::-moz-range-thumb {
    width: 16px;
    height: 16px;
    background: var(--accent);
    border-radius: 50%;
    border: none;
    cursor: pointer;
    box-shadow: 0 0 2px rgba(0,0,0,0.4);
  }
  #customAlert {
  position: fixed;
  top: 0; left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 99999;
}

#customAlertBackdrop {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  backdrop-filter: blur(2px);
}

#customAlertBox {
  position: relative;
  background-color: var(--card-bg);
  color: var(--text-colour);
  padding: 1.5rem;
  border-radius: 12px;
  border: 1px solid var(--accent);
  box-shadow: 0 8px 24px rgba(0,0,0,0.45);
  max-width: 400px;
  width: 90%;
  z-index: 1;
  text-align: center;
}

#customAlertBox h3 {
  margin-top: 0;
  color: var(--accent);
  font-size: 1.2rem;
}

#customAlertBox p {
  margin: 1rem 0;
  font-size: 0.95rem;
  line-height: 1.4;
}

#customAlertBox .btn {
  margin-top: 0.5rem;
}

  </style>
</head>
<body>
  <header class="sticky-header">
    <div class="header-row">
      <div>
        <h1>📊 Custom Income Portfolio Tool</h1>
        <small style="color: var(--muted-text);">Plan &amp; track your personalised income portfolio</small>
      </div>
      <nav>
  <a href="#portfolio-overview">Portfolio Overview</a>
        <a href="#holdings">Holdings</a>
        <a href="#contribution">Contribute</a>
        <a href="#income-calc">Income</a>
        <a href="#growth">Growth</a>
        <div style="position:relative;display:inline-block;">
    <button id="settingsDropdownBtn" class="btn" type="button">Settings ▼</button>
    <div id="settingsDropdown" style="display:none;position:absolute;right:0;top:110%;background:var(--card-bg);border:1px solid var(--border-colour);border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.25);padding:1rem;z-index:2000;min-width:220px;">
      <p style="margin:0 0 0.5rem 0;font-weight:600;">Settings</p>
      <!-- Portfolio Manager UI -->
      <div style="margin-bottom:0.75rem;">
        <label for="portfolioSelect" style="font-size:0.95em;color:var(--muted-text);font-weight:600;">Portfolio Manager</label>
        <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
          <select id="portfolioSelect" class="styled-input" style="flex:2;min-width:0;"></select>
          <button id="loadPortfolioBtn" class="btn" style="flex:1;white-space:nowrap;min-width:90px;">Load</button>
        </div>
        <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
          <input type="text" id="portfolioNameInput" class="styled-input" placeholder="New portfolio name" style="flex:2;min-width:0;" />
          <button id="addPortfolioBtn" class="btn" style="flex:1;white-space:nowrap;min-width:90px;">Add New</button>
        </div>
        <div style="display:flex;gap:0.5rem;">
          <button id="renamePortfolioBtn" class="btn" style="flex:1;">Rename</button>
          <button id="deletePortfolioBtn" class="btn" style="flex:1;background-color:#d9534f;color:#fff;border-color:#d9534f;">Delete</button>
        </div>
      </div>
      <button id="exportBtn" class="btn" style="width:100%;margin-bottom:0.5rem;">Export Configuration</button>
      <input type="file" id="importFile" accept="application/json" style="display:none;" />
      <button id="importBtn" class="btn" style="width:100%;margin-bottom:0.5rem;">Import Configuration</button>
      <button id="themeToggle" class="btn" style="width:100%;">Toggle Light/Dark Mode</button>
      <button id="defaultDripToggle" class="btn" style="width:100%;margin-top:0.5rem;">
        Default DRIP State: <span id="defaultDripStateLabel">ON</span>
      </button>
      <button id="resetAllBtn" class="btn" style="width:100%;margin-top:0.5rem;background-color:#d9534f;color:#fff;border-color:#d9534f;">Reset All Data</button>
  <button id="comparePortfoliosBtn" class="btn" style="width:100%;margin-top:0.5rem;">Compare Portfolios</button>
    </div>
  </div>
      </nav>
    </div>
  </header>

  <!-- Tooltip placeholder; content filled by JS -->
  <div id="tooltip" class="tooltip"></div>

  <!-- Compare Portfolios Modal -->
  <div id="comparePortfoliosModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;">
  <div class="modal-fade" id="comparePortfoliosModalInner" style="background:var(--card-bg);color:var(--text-colour);max-width:1100px;width:98vw;padding:2rem 2.5rem;border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,0.30);position:relative;max-height:90vh;overflow-y:auto;">
      <button id="closeComparePortfoliosModal" class="btn" style="position:absolute;top:1rem;right:1rem;">Close</button>
      <h2>Compare Portfolios</h2>
  <p>Select up to five <strong>saved portfolios</strong> to compare their metrics side-by-side. Only portfolios that have been saved will appear in the dropdowns.</p>
      <div id="comparePortfolioSelectors" style="display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;"></div>
      <div id="comparePortfolioResults"></div>
    </div>
  </div>


  <!-- Overview and Glossary pop-out modals -->
  <div id="overviewModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;">
  <div class="modal-fade" id="overviewModalInner" style="background:var(--card-bg);color:var(--text-colour);max-width:820px;width:98vw;padding:2rem 2.5rem;border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,0.30);position:relative;">
      <button id="closeOverviewModal" class="btn" style="position:absolute;top:1rem;right:1rem;">Close</button>
      <h2>Overview</h2>
      <p>This tool helps you design a personalized income and growth portfolio. Add your holdings, set weights, and see real-time projections for income and portfolio growth. The tool supports both price growth and total growth (with DRIP), and provides instant breakdowns by holding and asset class.</p>
      <p><strong>Fetch Data:</strong> Enter a ticker symbol (e.g., <code>SCHD</code>, <code>VTSAX</code>, <code>AAPL</code>) to auto-fill fund details. You can edit any value before adding. Coverage varies by ticker.</p>
      <h3 style="margin-top:0;">How to Use</h3>
      <ol style="margin-bottom:1rem;">
        <li><strong>Add Holdings:</strong> Enter or fetch fund details, then click <b>Add</b>.</li>
        <li><strong>Adjust Weights:</strong> Set allocation for each holding (total must not exceed 100%).</li>
        <li><strong>Contribution Allocator:</strong> See how a lump sum would be distributed across holdings.</li>
        <li><strong>Income Calculator:</strong> Use the slider to estimate annual, quarterly, and monthly income.</li>
        <li><strong>Growth Projection:</strong> Model portfolio growth over time, with or without DRIP, and view Rule of 72 estimates for both scenarios.</li>
        <li><strong>Breakdowns & Charts:</strong> View per-holding and per-asset-class breakdowns, and switch between table and pie chart views.</li>
        <li><strong>Settings:</strong> Export/import portfolios, change theme, and manage DRIP defaults.</li>
      </ol>
      <ul style="margin-bottom:0.5rem;">
        <li>Supports <b>DRIP</b> toggles per holding</li>
        <li>Shows both per-holding and per-asset-class income breakdowns</li>
        <li>Visualize allocations with pie chart or table</li>
        <li>Growth chart with Rule of 72 estimates for both DRIP and non-DRIP</li>
        <li>All data is stored locally in your browser for privacy</li>
      </ul>
    </div>
  </div>
  <div id="glossaryModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99999;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;">
  <div class="modal-fade" id="glossaryModalInner" style="background:var(--card-bg);color:var(--text-colour);max-width:820px;width:98vw;padding:2rem 2.5rem;border-radius:16px;box-shadow:0 16px 48px rgba(0,0,0,0.30);position:relative;">
      <button id="closeGlossaryModal" class="btn" style="position:absolute;top:1rem;right:1rem;">Close</button>
      <h2>Glossary &amp; Definitions</h2>
      <dl style="margin-top:1rem;">
        <dt><strong>Distribution Rate (Yield)</strong></dt>
        <dd>The annualized dividend/distribution rate as a percentage of fund value.</dd>
        <dt><strong>Average Annual Growth Rate (CAGR)</strong></dt>
        <dd>The mean annual rate at which an investment has grown, used for projecting future value.</dd>
        <dt><strong>Expense Ratio</strong></dt>
        <dd>The annual fee charged by funds, expressed as a percentage of assets.</dd>
        <dt><strong>DRIP (Dividend Reinvestment Plan)</strong></dt>
        <dd>Automatically reinvests distributions into the holding, accelerating growth through compounding.</dd>
        <dt><strong>Weighted Distribution Yield</strong></dt>
        <dd>Portfolio-wide yield, calculated by weighting each holding’s yield by its allocation.</dd>
        <dt><strong>Rule of 72</strong></dt>
        <dd>Quick estimate of years required to double your investment: 72 divided by annual return. Shown for both DRIP and non-DRIP scenarios.</dd>
        <dt><strong>Income Frequencies</strong></dt>
        <dd>Funds may pay distributions weekly, monthly, quarterly, semi-annually, or annually.</dd>
        <dt><strong>Breakdowns</strong></dt>
        <dd>Income and growth breakdowns are shown by holding and by asset class.</dd>
        <dt><strong>Chart Types</strong></dt>
        <dd>Switch between pie chart and table views for allocations; growth chart supports bar and line modes.</dd>
        <dt><strong>Local Privacy</strong></dt>
        <dd>All portfolio data is stored locally in your browser; nothing is sent to a server.</dd>
      </dl>
    </div>
  </div>

  <!-- Overall Summary Card (Category Weights + Portfolio Summary) -->
  <section class="card" id="portfolio-overview">
    <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;">
  <h2 style="margin-bottom:0.5rem;">1. Portfolio Overview</h2>
      <div style="color: var(--muted-text); font-size:1rem; font-weight:600; margin-left:1rem;">
        <span style="background:var(--hover-bg);padding:0.4em 1em;border-radius:6px;">Selected Portfolio: <span id="portfolioSummaryName"></span></span>
      </div>
    </div>
    <div style="margin:1.2rem 0 1.5rem 0;">
      <div style="background:var(--hover-bg);border:1px solid var(--border-colour);border-radius:10px;padding:1.1rem 1.5rem;display:flex;flex-wrap:wrap;gap:2.5rem;align-items:center;justify-content:space-between;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
        <div id="portfolioSummary" style="font-size:1.15rem;font-weight:500;"></div>
        <div id="portfolioHoldingsCount" style="font-size:1.05rem;color:var(--muted-text);font-weight:600;"></div>
        <div style="display:flex;gap:1rem;align-items:center;">
          <button id="showOverviewBtn" class="btn" style="font-size:0.98rem;">How To</button>
          <button id="showGlossaryBtn" class="btn" style="font-size:0.98rem;">Show Glossary</button>
        </div>
      </div>
    </div>
    <h3 style="margin-top:2rem;margin-bottom:0.5rem;">Asset Class Breakdown</h3>
    <p style="margin-bottom:0.5rem;">The table below aggregates your holdings by asset class. Whenever you add or remove a holding, these totals update automatically. If you prefer a visual breakdown, toggle the chart view in the holdings section.</p>
    <table>
      <thead><tr><th>Asset Class</th><th>Weight</th></tr></thead>
      <tbody id="categoryWeightsBody"></tbody>
    </table>
  </section>

  <!-- Holdings section with dynamic inputs -->
  <section class="card" id="holdings">
    <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem;">
  <h2 style="margin:0;">2. Holdings</h2>
      <div style="display:flex;gap:0.5rem;">
        <button id="toggleHoldingsView" class="btn">Switch to Pie Chart</button>
        <button id="downloadHoldingsCSV" class="btn">Download Holdings as CSV</button>
      </div>
    </div>
    <p>Add positions to your portfolio.  Enter fund metrics manually or attempt to fetch them automatically.</p>
    <div class="input-row">
      <div class="input-group">
        <label for="newName">Fund Name</label>
        <input type="text" id="newName" class="styled-input" placeholder="e.g. Schwab U.S. Dividend Equity ETF" />
      </div>
      <div class="input-group">
        <label for="newTicker">Ticker</label>
        <input type="text" id="newTicker" class="styled-input" placeholder="e.g. SCHD" />
      </div>
      <div class="input-group">
        <label for="newClass">Asset Class</label>
        <input type="text" id="newClass" class="styled-input" placeholder="e.g. Dividend Growth" />
      </div>
      <div class="input-group">
        <label for="newWeight">Weight (%)</label>
        <input type="number" id="newWeight" class="styled-input" min="0" step="0.1" placeholder="0" />
      </div>
      <div class="input-group">
  <label for="newYield">Distribution Rate (Yield %)</label>
  <input type="number" id="newYield" class="styled-input" min="0" step="0.01" placeholder="3.89" />
      </div>
      <div class="input-group">
        <label for="newCAGR">Average Annual Growth Rate (%)</label>
        <input type="number" id="newCAGR" class="styled-input" min="0" step="0.1" placeholder="10" />
      </div>
      <div class="input-group">
        <label for="newExpense">Expense Ratio (%)</label>
        <input type="number" id="newExpense" class="styled-input" min="0" step="0.01" placeholder="0.06" />
      </div>
      <div class="input-group">
        <label for="newSchedule">Payment Schedule</label>
        <select id="newSchedule" class="styled-input">
          <option value="monthly">Monthly</option>
          <option value="quarterly">Quarterly</option>
          <option value="semi">Semi‑Annually</option>
          <option value="annual">Annually</option>
          <option value="weekly">Weekly</option>
        </select>
      </div>
      <div class="input-group" style="flex-basis:100%;display:flex;align-items:flex-end;gap:0.5rem;">
	<button id="fetchMetrics" class="btn" style="flex:0 0 auto;">Fetch</button>
	<button id="addHolding" class="btn" style="flex:1;">Add</button>
	</div>

    </div>
    <div style="margin-top:1rem;overflow-x:auto;">
      <table>
        <thead>
  <tr>
    <th data-sort="name"><span>Name</span></th>
    <th data-sort="ticker"><span>Ticker</span></th>
    <th data-sort="class"><span>Class</span></th>
    <th data-sort="weight"><span>Weight (%)</span></th>
    <th data-sort="yield"><span>Yield</span></th>
    <th data-sort="cagr"><span>Avg Annual Growth (%)</span></th>
    <th data-sort="expense"><span>Expense</span></th>
    <th data-sort="schedule"><span>Schedule</span></th>
    <th>DRIP</th>
    <th>Actions</th>
  </tr>
</thead>

        <tbody id="holdingsBody"></tbody>
        <tfoot id="holdingsTotals"></tfoot>
      </table>
    </div>
    <!-- Container for the pie chart of holdings -->
    <div id="holdingsChartContainer">
      <canvas id="holdingsChart" height="300"></canvas>
    </div>
  </section>

  <!-- Contribution allocator -->
  <section class="card" id="contribution">
  <h2>3. Contribution Allocator</h2>
    <p>Allocate a lump sum according to your target weights. Enter an amount and see how much goes to each holding.</p>
    <div class="input-group" style="max-width:200px;">
      <label for="contributionInput">Contribution Amount ($)</label>
      <input type="number" id="contributionInput" class="styled-input" min="0" step="100" value="0" />
    </div>
    <button id="exportContributionCSV" class="btn" style="margin-top:0.5rem;">Export Allocation as CSV</button>
    <div id="allocationBreakdown" style="margin-top:1rem; display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:0.75rem;"></div>
  </section>

  <!-- Income calculator -->
  <section class="card" id="income-calc">
  <h2>4. Income Calculator</h2>
<p>This calculator provides a <strong>theoretical estimate</strong> of your portfolio’s income based on a constant weighted average distribution yield. The yield is automatically calculated from your holdings in the portfolio section, while you can adjust the current portfolio value using the slider (in $1,000 increments) to explore different scenarios. The display includes:</p>
<ul>
  <li><strong>Annual, Quarterly, and Monthly Income</strong></li>
  <li><strong>Income by Holding</strong> – individual security breakdown</li>
  <li><strong>Income by Asset Class</strong> – category-level breakdown</li>
</ul>
<p>Results are for illustrative purposes only and do not represent actual or guaranteed income.</p>

    <!-- Allow the slider to span the full width of the card for fine‑tuned adjustments -->
    <div class="input-group" style="width:100%;">
      <label for="accountSlider">Portfolio Value (<span id="sliderVal">$0</span>)</label>
      <!-- Step reduced to $1000 increments for finer control -->
      <input type="range" id="accountSlider" min="0" max="2000000" step="1000" value="0" />
    </div>
    <div style="margin-top:0.5rem;">
      <strong>Weighted Distribution Yield:</strong> <span id="weightedYield">0.00%</span>
    </div>
    <div class="result-box" style="margin-top:1rem;font-size:1.1rem;">
      <strong>Annual:</strong> <span id="annualIncome">$0</span> |
      <strong>Quarterly:</strong> <span id="quarterIncome">$0</span> |
      <strong>Monthly:</strong> <span id="monthlyIncome">$0</span>
    </div>
    <div id="incomeToggleBtns" style="margin-top:1rem; display:flex; flex-wrap:wrap; gap:0.5rem;">
      <button id="toggleDetailedIncome" class="btn">Show Per-Holding Breakdown</button>
      <button id="toggleClassIncome" class="btn">Show Asset‑Class Income</button>
    </div>
    <div id="detailedIncomeBreakdown" style="display:none;margin-top:1rem;"></div>
    <div id="classIncomeBreakdown" style="display:none;margin-top:1rem;"></div>
  </section>

  <!-- Growth projection -->
  <section class="card" id="growth">
  <h2>5. Growth Projection</h2>
<p>This chart provides a <strong>theoretical projection</strong> of how your portfolio might grow over time based on a constant weighted average annual return. The starting amount and return rate are automatically calculated from your inputs in other sections of the portfolio tool. The projection includes:</p>
<ul>
  <li><strong>Total Contributions</strong></li>
  <li><strong>Price Growth</strong> – average annual growth only</li>
  <li><strong>Total Growth</strong> – average annual growth plus reinvested distributions (DRIP)</li>
</ul>
<p>You can adjust your contribution amount, contribution frequency, and number of years to see different scenarios. Results are for illustrative purposes only and do not represent actual or guaranteed performance.</p>
    <div class="input-row">
      <!-- Show the portfolio value from the Income Calculator as the initial amount; no editing here -->
      <div style="display: flex; flex-wrap: wrap; gap: 1.2rem; width: 100%; align-items: flex-end;">
  <div class="input-group" style="min-width: 110px;">
          <label>Initial ($)</label>
          <div id="growthInitialDisplay" class="styled-input" style="background-color: transparent; border: none; padding-top: 0.5rem;">
            $0
          </div>
        </div>
  <div class="input-group" style="min-width: 140px;">
          <label for="growthContribution">Contribution Amount($)</label>
          <input type="number" id="growthContribution" class="styled-input" min="0" step="100" value="0" />
        </div>
  <div class="input-group" style="min-width: 130px;">
          <label for="growthFrequency">Contribution Frequency</label>
          <select id="growthFrequency" class="styled-input">
            <option value="yearly" selected>Yearly</option>
            <option value="monthly">Monthly</option>
            <option value="biweekly">Biweekly</option>
            <option value="weekly">Weekly</option>
          </select>
        </div>
  <div class="input-group" style="min-width: 90px;">
          <label for="growthYears">Years</label>
          <input type="number" id="growthYears" class="styled-input" min="1" step="1" value="10" />
        </div>
        <div style="display:flex; align-items:center; gap:1.2rem; flex-wrap:wrap; margin-top:0.5rem;">
          <div class="input-group" style="min-width: 120px; align-items: flex-start;">
            <label for="weightedAnnualReturnNoDrip" style="margin-bottom:0.25rem; color: var(--muted-text); font-size: 0.75rem; white-space:nowrap;">Weighted Annual Return (No DRIP)</label>
            <span id="weightedAnnualReturnNoDrip" style="font-weight:bold; color:#fdd000; font-size:1.05rem;">0.00%</span>
          </div>
          <div class="input-group" style="min-width: 120px; align-items: flex-start;">
            <label for="weightedAnnualReturnWithDrip" style="margin-bottom:0.25rem; color: var(--muted-text); font-size: 0.75rem; white-space:nowrap;">Weighted Annual Return (With DRIP)</label>
            <span id="weightedAnnualReturnWithDrip" style="font-weight:bold; color:#4cc9f0; font-size:1.05rem;">0.00%</span>
          </div>
        </div>
      </div>
    </div>
    <div style="display:flex; gap:0.75rem; margin-top:1rem;">
  <button id="toggleGrowthChart" class="btn" style="margin-top:0;">Switch to Line Chart</button>
  <button id="showGrowthBreakdownBtn" class="btn" style="margin-top:0;">Show Yearly Breakdown Table</button>
  <div id="ruleOf72Estimate" style="margin-left:1rem; color:var(--muted-text); font-size:0.98rem;"></div>
  </div>
    <!-- Smaller chart height for better fit on screen -->
    <div style="width:100%; display:flex; justify-content:center;">
      <div style="width:100%; display:flex; justify-content:center;">
  <canvas id="growthChart" height="320" style="margin-top:1rem; max-width: min(90vw, 1100px); width:100%; max-height:320px; border-radius:16px; box-shadow:0 2px 12px rgba(0,0,0,0.10); background: var(--card-bg); padding: 8px;"></canvas>
      </div>
    </div>
  </section>



  <!-- Footer -->
  <footer style="margin:2rem; text-align:center; color: var(--muted-text); font-size:0.85rem;">
    <p>© 2025 JoshDisciple. This tool is for educational purposes only and does not constitute financial advice.</p>
    <p>Created by <a href="https://twitter.com/JoshDisciple" target="_blank" style="color: var(--accent);">@JoshDisciple</a></p>
    <p>Version: 1.1.7 | Release Date: Aug 10, 2025</p>
    <p>Support development of this tool on <a href="https://www.patreon.com/c/JoshDisciple"> Patreon<a/></p>
  </footer>

  <!-- Sticky Income Summary Bar -->
  <div class="income-summary">
    <div>
      <strong>Summary:</strong> Annual Income: <span id="summaryAnnual">$0</span> | Quarterly: <span id="summaryQuarter">$0</span> | Monthly: <span id="summaryMonthly">$0</span>
    </div>
    <div>
      Total Portfolio: <span id="summaryPortfolio">$0</span> | Annual Fees: <span id="summaryAnnualFees">$0</span>
    </div>
  </div>

  <script>
  // --- New Feature: Download Holdings as CSV ---
  document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('downloadHoldingsCSV');
    if (btn) {
      btn.addEventListener('click', function() {
        if (!holdings.length) {
          showCustomAlert('No holdings to export.');
          return;
        }
        const rows = [['Name','Ticker','Class','Weight','Yield','CAGR','Expense','Schedule','DRIP']];
        holdings.forEach(h => {
          rows.push([
            h.name,
            h.ticker,
            h.class,
            h.weight,
            h.yield,
            h.cagr,
            h.expense,
            h.schedule,
            h.drip ? 'ON' : 'OFF'
          ]);
        });
        downloadCSV('holdings.csv', rows);
      });
    }
  });

  // --- Overview and Glossary Modal Logic ---
  document.addEventListener('DOMContentLoaded', function() {
    var overviewBtn = document.getElementById('showOverviewBtn');
    var overviewModal = document.getElementById('overviewModal');
      var overviewModalInner = document.getElementById('overviewModalInner');
    var closeOverview = document.getElementById('closeOverviewModal');
    if (overviewBtn && overviewModal && closeOverview) {
      overviewBtn.addEventListener('click', function() {
          overviewModal.style.display = 'flex';
          setTimeout(function() {
            overviewModalInner.classList.add('show');
          }, 10);
      });
      closeOverview.addEventListener('click', function() {
          overviewModalInner.classList.remove('show');
          setTimeout(function() {
            overviewModal.style.display = 'none';
          }, 350);
      });
      overviewModal.addEventListener('click', function(e) {
          if (e.target === overviewModal) {
            overviewModalInner.classList.remove('show');
            setTimeout(function() {
              overviewModal.style.display = 'none';
            }, 350);
          }
      });
    }
    var glossaryBtn = document.getElementById('showGlossaryBtn');
    var glossaryModal = document.getElementById('glossaryModal');
      var glossaryModalInner = document.getElementById('glossaryModalInner');
    var closeGlossary = document.getElementById('closeGlossaryModal');
    if (glossaryBtn && glossaryModal && closeGlossary) {
      glossaryBtn.addEventListener('click', function() {
          glossaryModal.style.display = 'flex';
          setTimeout(function() {
            glossaryModalInner.classList.add('show');
          }, 10);
      });
      closeGlossary.addEventListener('click', function() {
          glossaryModalInner.classList.remove('show');
          setTimeout(function() {
            glossaryModal.style.display = 'none';
          }, 350);
      });
      glossaryModal.addEventListener('click', function(e) {
          if (e.target === glossaryModal) {
            glossaryModalInner.classList.remove('show');
            setTimeout(function() {
              glossaryModal.style.display = 'none';
            }, 350);
          }
      });
    }
  });
  function updatePortfolioSummary() {
    var nameSpan = document.getElementById('portfolioSummaryName');
    if (nameSpan) {
      nameSpan.textContent = getActivePortfolioName();
    }
    var summaryDiv = document.getElementById('portfolioSummary');
    var countDiv = document.getElementById('portfolioHoldingsCount');
    if (!holdings.length) {
      if (summaryDiv) summaryDiv.innerHTML = '<em>No holdings in portfolio.</em>';
      if (countDiv) countDiv.textContent = '';
      return;
    }
    let totalWeight = 0, totalYield = 0, totalCAGR = 0, totalExpense = 0;
    holdings.forEach(h => {
      const w = parseFloat(h.weight) || 0;
      totalWeight += w;
      totalYield += w * (parseFloat(h.yield) || 0) / 100;
      totalCAGR += w * (parseFloat(h.cagr) || 0) / 100;
      totalExpense += w * (parseFloat(h.expense) || 0) / 100;
    });
  const summary = `<span style="color:var(--accent);font-weight:600;">Total Weight:</span> ${totalWeight.toFixed(2)}% | <span style="color:var(--accent);font-weight:600;">Weighted Yield:</span> ${(totalYield).toFixed(2)}% | <span style="color:var(--accent);font-weight:600;">Weighted Annual Growth:</span> ${(totalCAGR).toFixed(2)}% | <span style="color:var(--accent);font-weight:600;">Weighted Expense:</span> ${(totalExpense).toFixed(2)}%`;
    if (summaryDiv) summaryDiv.innerHTML = summary;
    if (countDiv) countDiv.textContent = `Holdings: ${holdings.length}`;
  }
  // Call on load and after holdings change
  document.addEventListener('DOMContentLoaded', updatePortfolioSummary);
  function updateAllSummaries() {
    updatePortfolioSummary();
    // ...existing code...
  }
  // Patch saveHoldings and renderHoldingsTable to call updatePortfolioSummary
  const origSaveHoldings = saveHoldings;
  saveHoldings = function() {
    origSaveHoldings.apply(this, arguments);
    updatePortfolioSummary();
  };
  const origRenderHoldingsTable = renderHoldingsTable;
  renderHoldingsTable = function() {
    origRenderHoldingsTable.apply(this, arguments);
    updatePortfolioSummary();
  };
  // Portfolio Manager: handles saving, loading, renaming, and deleting portfolios
  const PORTFOLIOS_KEY = 'customPortfolioList';
  const ACTIVE_PORTFOLIO_KEY = 'customPortfolioActive';
  function getPortfolios() {
    const raw = localStorage.getItem(PORTFOLIOS_KEY);
    return raw ? JSON.parse(raw) : {};
  }
  function savePortfolios(obj) {
    localStorage.setItem(PORTFOLIOS_KEY, JSON.stringify(obj));
  }
  function getActivePortfolioName() {
    return localStorage.getItem(ACTIVE_PORTFOLIO_KEY) || 'Default';
  }
  function setActivePortfolioName(name) {
    localStorage.setItem(ACTIVE_PORTFOLIO_KEY, name);
  }
  function updatePortfolioDropdown() {
    const select = document.getElementById('portfolioSelect');
    if (!select) return;
    const portfolios = getPortfolios();
    select.innerHTML = '';
    Object.keys(portfolios).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      select.appendChild(opt);
    });
    select.value = getActivePortfolioName();
  }
  function loadPortfolio(name) {
    const portfolios = getPortfolios();
    if (portfolios[name]) {
      setActivePortfolioName(name);
      holdings = portfolios[name];
      renderHoldingsTable();
      updateCategoryWeights();
      updateContributionAllocation();
      updateIncome();
      updateGrowthChart();
      updatePortfolioSummary();
    }
  }
  function addNewPortfolio(name) {
    if (!name) return;
    const portfolios = getPortfolios();
    if (portfolios[name]) {
      showCustomAlert('A portfolio with that name already exists.');
      return;
    }
  portfolios[name] = [];
  savePortfolios(portfolios);
  setActivePortfolioName(name);
  holdings = [];
  saveHoldings();
  renderHoldingsTable();
  updateCategoryWeights();
  updateContributionAllocation();
  updateIncome();
  updateGrowthChart();
  updatePortfolioDropdown();
  updatePortfolioSummary();
  showCustomAlert('New blank portfolio "' + name + '" created and loaded.');
  }
  function saveCurrentPortfolio(name) {
    if (!name) return;
    const portfolios = getPortfolios();
    portfolios[name] = holdings;
    savePortfolios(portfolios);
  setActivePortfolioName(name);
  updatePortfolioDropdown();
  updatePortfolioSummary();
  showCustomAlert('Portfolio saved as "' + name + '".');
  }
  function renamePortfolio(oldName, newName) {
    if (!oldName || !newName) return;
    const portfolios = getPortfolios();
    if (portfolios[newName]) {
      showCustomAlert('A portfolio with that name already exists.');
      return;
    }
    portfolios[newName] = portfolios[oldName];
    delete portfolios[oldName];
    savePortfolios(portfolios);
  setActivePortfolioName(newName);
  updatePortfolioDropdown();
  updatePortfolioSummary();
  showCustomAlert('Portfolio renamed to "' + newName + '".');
  }
  function deletePortfolio(name) {
    const portfolios = getPortfolios();
    if (Object.keys(portfolios).length <= 1) {
      showCustomAlert('At least one portfolio must exist.');
      return;
    }
    delete portfolios[name];
    savePortfolios(portfolios);
    const first = Object.keys(portfolios)[0];
  setActivePortfolioName(first);
  loadPortfolio(first);
  updatePortfolioDropdown();
  updatePortfolioSummary();
  showCustomAlert('Portfolio deleted.');
  }
  document.addEventListener('DOMContentLoaded', () => {
    // Compare Portfolios button logic
    const compareBtn = document.getElementById('comparePortfoliosBtn');
    const compareModal = document.getElementById('comparePortfoliosModal');
    const compareModalInner = document.getElementById('comparePortfoliosModalInner');
    const closeCompare = document.getElementById('closeComparePortfoliosModal');
    if (compareBtn && compareModal && closeCompare) {
      compareBtn.addEventListener('click', function() {
        compareModal.style.display = 'flex';
        setTimeout(function() {
          compareModalInner.classList.add('show');
        }, 10);
        renderComparePortfolioSelectors();
      });
      closeCompare.addEventListener('click', function() {
        compareModalInner.classList.remove('show');
        setTimeout(function() {
          compareModal.style.display = 'none';
        }, 350);
      });
      compareModal.addEventListener('click', function(e) {
        if (e.target === compareModal) {
          compareModalInner.classList.remove('show');
          setTimeout(function() {
            compareModal.style.display = 'none';
          }, 350);
        }
      });
    }

    function renderComparePortfolioSelectors() {
      const portfolios = getPortfolios();
      const selectorDiv = document.getElementById('comparePortfolioSelectors');
      selectorDiv.innerHTML = '';
  for (let i = 0; i < 5; i++) {
        const select = document.createElement('select');
        select.className = 'styled-input';
        select.style.minWidth = '180px';
        select.innerHTML = '<option value="">Select Portfolio</option>';
        Object.keys(portfolios).forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          select.appendChild(opt);
        });
        select.onchange = renderComparePortfolioResults;
        selectorDiv.appendChild(select);
      }
      renderComparePortfolioResults();
    }

    function renderComparePortfolioResults() {
      const portfolios = getPortfolios();
      const selectorDiv = document.getElementById('comparePortfolioSelectors');
      const selects = selectorDiv.querySelectorAll('select');
      const selected = Array.from(selects).map(s => s.value).filter(v => v);
      const resultsDiv = document.getElementById('comparePortfolioResults');
      if (selected.length === 0) {
        resultsDiv.innerHTML = '<em>Select portfolios to compare.</em>';
        return;
      }
      // Gather metrics for each selected portfolio
      const metrics = selected.map(name => {
        const h = portfolios[name] || [];
        let totalWeight = 0, totalYield = 0, totalCAGR = 0, totalExpense = 0;
        h.forEach(holding => {
          const w = parseFloat(holding.weight) || 0;
          totalWeight += w;
          totalYield += w * (parseFloat(holding.yield) || 0) / 100;
          totalCAGR += w * (parseFloat(holding.cagr) || 0) / 100;
          totalExpense += w * (parseFloat(holding.expense) || 0) / 100;
        });
        return {
          name,
          holdings: h,
          totalWeight: totalWeight.toFixed(2),
          weightedYield: totalYield.toFixed(2),
          weightedCAGR: totalCAGR.toFixed(2),
          weightedExpense: totalExpense.toFixed(2)
        };
      });
      // Build comparison table only (metrics)
  let html = '<div style="width:100%;">';
  html += '<table style="width:100%;border-collapse:collapse;table-layout:fixed;">';
      html += '<thead><tr>';
      html += '<th>Metric</th>';
      metrics.forEach(m => {
        html += `<th style="color:var(--accent);font-weight:600;width:16%;word-break:break-word;">${m.name}</th>`;
      });
      html += '</tr></thead><tbody>';
      html += `<tr><td>Weighted Yield (%)</td>${metrics.map(m => `<td>${m.weightedYield}</td>`).join('')}</tr>`;
      html += `<tr><td>Weighted Growth (%)</td>${metrics.map(m => `<td>${m.weightedCAGR}</td>`).join('')}</tr>`;
      html += `<tr><td>Weighted Expense (%)</td>${metrics.map(m => `<td>${m.weightedExpense}</td>`).join('')}</tr>`;
      html += `<tr><td>Holdings Count</td>${metrics.map(m => `<td>${m.holdings.length}</td>`).join('')}</tr>`;
      html += '</tbody></table></div>';
      html += `<style>
        #comparePortfoliosModalInner table th, #comparePortfoliosModalInner table td { font-size: 0.98em; padding: 0.7em 0.3em; }
        @media (max-width: 1200px) {
          #comparePortfoliosModalInner table th, #comparePortfoliosModalInner table td { font-size: 0.92em; }
        }
        @media (max-width: 900px) {
          #comparePortfoliosModalInner table th, #comparePortfoliosModalInner table td { font-size: 0.88em; }
        }
        @media (max-width: 700px) {
          #comparePortfoliosModalInner table th, #comparePortfoliosModalInner table td { font-size: 0.82em; }
        }
      </style>`;
      resultsDiv.innerHTML = html;
    }
  // Portfolio dropdown: user must click Load to switch portfolios
    const select = document.getElementById('portfolioSelect');
    if (select) {
      select.addEventListener('change', function() {
        // No longer auto-load on change. User must click Load.
      });
    }
    // Add new portfolio button
    const addBtn = document.getElementById('addPortfolioBtn');
    if (addBtn) {
      addBtn.addEventListener('click', function() {
        const name = document.getElementById('portfolioNameInput').value.trim();
        if (!name) { showCustomAlert('Please enter a portfolio name.'); return; }
        addNewPortfolio(name);
        document.getElementById('portfolioNameInput').value = '';
      });
    }
    // Rename portfolio button
    const renameBtn = document.getElementById('renamePortfolioBtn');
    if (renameBtn) {
      renameBtn.addEventListener('click', function() {
        const select = document.getElementById('portfolioSelect');
        const newName = document.getElementById('portfolioNameInput').value.trim();
        if (!newName) { showCustomAlert('Please enter a new name.'); return; }
        renamePortfolio(select.value, newName);
        document.getElementById('portfolioNameInput').value = '';
      });
    }
    // Delete portfolio button
    const deleteBtn = document.getElementById('deletePortfolioBtn');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', function() {
        const select = document.getElementById('portfolioSelect');
        showCustomAlert('Delete portfolio "' + select.value + '"?', function() {
          deletePortfolio(select.value);
        });
      });
    }
    // Load portfolio button
    const loadBtn = document.getElementById('loadPortfolioBtn');
    if (loadBtn) {
      loadBtn.addEventListener('click', function() {
        const select = document.getElementById('portfolioSelect');
        loadPortfolio(select.value);
      });
    }
    // Initialise portfolios if none exist
    let portfolios = getPortfolios();
    if (Object.keys(portfolios).length === 0) {
      portfolios['Default'] = holdings;
      savePortfolios(portfolios);
      setActivePortfolioName('Default');
    }
    updatePortfolioDropdown();
  });
  // CSV export: download array of rows as a CSV file
  function downloadCSV(filename, rows) {
    const process = row => row.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',');
    const csv = rows.map(process).join('\r\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // Export: Contribution Allocator table as CSV
  document.getElementById('exportContributionCSV').addEventListener('click', function() {
    const amount = parseFloat(contributionInput.value) || 0;
    const rows = [['Ticker', 'Allocated Amount ($)']];
    holdings.forEach(h => {
      const allocated = (amount * parseFloat(h.weight) / 100).toFixed(2);
      rows.push([h.ticker, allocated]);
    });
    downloadCSV('contribution_allocation.csv', rows);
  });

  // Default DRIP State: load, save, and update UI for DRIP toggle
  const DRIP_KEY = 'defaultDripState';
  function loadDefaultDrip() {
    const val = localStorage.getItem(DRIP_KEY);
    return val === null ? true : val === 'true';
  }
  function saveDefaultDrip(val) {
    localStorage.setItem(DRIP_KEY, val ? 'true' : 'false');
  }
  function updateDripToggleUI() {
    const btn = document.getElementById('defaultDripToggle');
    const label = document.getElementById('defaultDripStateLabel');
    if (!btn || !label) return;
    const state = loadDefaultDrip();
    label.textContent = state ? 'ON' : 'OFF';
    btn.style.backgroundColor = state ? 'var(--accent)' : 'var(--card-bg)';
    btn.style.color = state ? 'var(--card-bg)' : 'var(--accent)';
    btn.style.borderColor = 'var(--accent)';
  }
  document.addEventListener('DOMContentLoaded', () => {
    updateDripToggleUI();
    const btn = document.getElementById('defaultDripToggle');
    if (btn) {
      btn.addEventListener('click', function() {
        const newState = !loadDefaultDrip();
        saveDefaultDrip(newState);
        updateDripToggleUI();
      });
    }
  });
  /* Holdings data model: array of objects, each with name, ticker, class, weight, yield, cagr, expense, schedule, drip */

  //
  
  const LS_KEY = 'customPortfolioHoldings';
  const API_KEY = 'XZCCWSGO24QFND4T';
  let holdings = [];
  let chartType = 'bar';
  let growthChartInstance = null;
  let holdingsChart = null;
  const holdingsBody = document.getElementById('holdingsBody');
  const categoryWeightsBody = document.getElementById('categoryWeightsBody');
  const contributionInput = document.getElementById('contributionInput');
  const allocationBreakdown = document.getElementById('allocationBreakdown');
  const accountSlider = document.getElementById('accountSlider');
  const sliderValSpan = document.getElementById('sliderVal');
  const annualSpan = document.getElementById('annualIncome');
  const quarterSpan = document.getElementById('quarterIncome');
  const monthlySpan = document.getElementById('monthlyIncome');
  const summaryAnnual = document.getElementById('summaryAnnual');
  const summaryQuarter = document.getElementById('summaryQuarter');
  const summaryMonthly = document.getElementById('summaryMonthly');
  const summaryPortfolio = document.getElementById('summaryPortfolio');
  const weightedYieldSpan = document.getElementById('weightedYield');
  const detailedIncomeDiv = document.getElementById('detailedIncomeBreakdown');
  const tooltipDiv = document.getElementById('tooltip');

  // Track index being edited; -1 when not editing
  let editingIndex = -1;

  // Load holdings from localStorage and update UI
  function loadHoldings() {
    const stored = localStorage.getItem(LS_KEY);
    holdings = stored ? JSON.parse(stored) : [];
    renderHoldingsTable();
    updateCategoryWeights();
    updateContributionAllocation();
    updateIncome();
    updateGrowthChart();
  }

  // Save holdings to localStorage and update active portfolio
  function saveHoldings() {
    localStorage.setItem(LS_KEY, JSON.stringify(holdings));
    // Also auto-save to current portfolio
    const active = getActivePortfolioName();
    const portfolios = getPortfolios();
    portfolios[active] = holdings;
    savePortfolios(portfolios);
  }

  // Render holdings table: create rows for each holding
  function renderHoldingsTable() {
    holdingsBody.innerHTML = '';
    holdings.forEach((h, index) => {
      const tr = document.createElement('tr');
      tr.dataset.tooltip = `Yield: ${h.yield.toFixed(2)}%\nExpense: ${h.expense}%\nAvg Annual Growth: ${h.cagr}%`;
      tr.innerHTML = `
        <td>${h.name}</td>
        <td><a href="https://finance.yahoo.com/quote/${h.ticker}" target="_blank">${h.ticker}</a></td>
        <td>${h.class}</td>
        <td>${parseFloat(h.weight).toFixed(2)}%</td>
        <td>${h.yield.toFixed(2)}%</td>
        <td>${parseFloat(h.cagr).toFixed(2)}%</td>
        <td>${parseFloat(h.expense).toFixed(2)}%</td>
        <td>${h.schedule}</td>
        <td><input type="checkbox" ${h.drip ? 'checked' : ''} data-index="${index}" class="drip-toggle" /></td>
        <td>
          <button data-index="${index}" class="btn btn-edit">Edit</button>
          <button data-index="${index}" class="btn btn-delete" style="margin-left:0.3rem;">Delete</button>
        </td>
      `;
      holdingsBody.appendChild(tr);
    });
    renderHoldingsTotals();
    attachRowEvents();
  }

  function renderHoldingsTotals() {
  const totalsRow = document.getElementById('holdingsTotals');
  if (!totalsRow) return;
  if (!holdings.length) {
    totalsRow.innerHTML = '';
    return;
  }
  // Weighted averages
  let totalWeight = 0;
  let weightedYield = 0;
  let weightedCagr = 0;
  let weightedExpense = 0;
  holdings.forEach(h => {
    const weight = parseFloat(h.weight) / 100;
    totalWeight += parseFloat(h.weight);
    weightedYield += weight * (h.yield);
    weightedCagr += weight * (h.cagr);
    weightedExpense += weight * (h.expense);
  });
  // Format row
  totalsRow.innerHTML = `
    <tr style="background: var(--hover-bg); font-weight: bold;">
      <td colspan="3" style="text-align:right;">Weighted Totals:</td>
      <td>${totalWeight.toFixed(2)}</td>
      <td>${weightedYield.toFixed(2)}%</td>
      <td>${weightedCagr.toFixed(2)}%</td>
      <td>${weightedExpense.toFixed(2)}%</td>
      <td colspan="3"></td>
    </tr>
  `;
}

  // Attach row events: tooltips, delete, edit, DRIP toggle
  function attachRowEvents() {
    // Show tooltip when hovering over any cell in a row
    holdingsBody.querySelectorAll('tr').forEach(row => {
      row.addEventListener('mouseenter', e => {
        const message = row.dataset.tooltip;
        tooltipDiv.textContent = message;
        tooltipDiv.style.display = 'block';
      });
      row.addEventListener('mousemove', e => {
        const x = e.pageX + 10;
        const y = e.pageY + 10;
        tooltipDiv.style.left = x + 'px';
        tooltipDiv.style.top = y + 'px';
      });
      row.addEventListener('mouseleave', () => {
        tooltipDiv.style.display = 'none';
      });
    });
    // Delete buttons
    document.querySelectorAll('.btn-delete').forEach(btn => {
      btn.addEventListener('click', e => {
        const idx = parseInt(e.target.getAttribute('data-index'));
        holdings.splice(idx, 1);
        saveHoldings();
        renderHoldingsTable();
        updateCategoryWeights();
        updateContributionAllocation();
        updateIncome();
        updateGrowthChart();
      });
    });

    // Edit buttons
    document.querySelectorAll('.btn-edit').forEach(btn => {
      btn.addEventListener('click', e => {
        const idx = parseInt(e.target.getAttribute('data-index'));
        editingIndex = idx;
        const h = holdings[idx];
        // Populate form with existing values
        document.getElementById('newName').value = h.name;
        document.getElementById('newTicker').value = h.ticker;
        document.getElementById('newClass').value = h.class;
        document.getElementById('newWeight').value = h.weight;
        document.getElementById('newYield').value = h.yield;
        document.getElementById('newCAGR').value = h.cagr;
        document.getElementById('newExpense').value = h.expense;
        document.getElementById('newSchedule').value = h.schedule;
        // Change Add button label to indicate update
        document.getElementById('addHolding').textContent = 'Update';
      });
    });
    // DRIP toggles
    document.querySelectorAll('.drip-toggle').forEach(chk => {
      chk.addEventListener('change', e => {
        const idx = parseInt(e.target.getAttribute('data-index'));
        holdings[idx].drip = e.target.checked;
        saveHoldings();
        updateGrowthChart();
      });
    });
  }

  // Update category weights table
  function updateCategoryWeights() {
    const totals = {};
    holdings.forEach(h => {
      if (!totals[h.class]) totals[h.class] = 0;
      totals[h.class] += parseFloat(h.weight);
    });
    categoryWeightsBody.innerHTML = '';
    Object.keys(totals).forEach(cls => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${cls}</td><td>${totals[cls].toFixed(2)}%</td>`;
      categoryWeightsBody.appendChild(tr);
    });
  }

  // Update contribution allocation display
  function updateContributionAllocation() {
    const amount = parseFloat(contributionInput.value) || 0;
    allocationBreakdown.innerHTML = '';
    holdings.forEach(h => {
      const allocated = (amount * parseFloat(h.weight) / 100).toFixed(2);
      const box = document.createElement('div');
      box.style.backgroundColor = 'var(--hover-bg)';
      box.style.border = '1px solid var(--border-colour)';
      box.style.borderRadius = '6px';
      box.style.padding = '0.5rem';
      box.style.fontSize = '0.85rem';
      box.innerHTML = `<strong>${h.ticker}:</strong> $${Number(allocated).toLocaleString()}`;
      allocationBreakdown.appendChild(box);
    });
  }

  contributionInput.addEventListener('input', updateContributionAllocation);

  // Income calculation functions
  function updateIncome() {
    const portfolio = parseFloat(accountSlider.value) || 0;
    sliderValSpan.textContent = `$${Number(portfolio).toLocaleString()}`;
    let annual = 0;
    let weightedYield = 0;
    holdings.forEach(h => {
      const weight = parseFloat(h.weight) / 100;
      const value = portfolio * weight;
      // Convert percent to decimal for calculation
      const income = value * (h.yield / 100);
      annual += income;
      weightedYield += weight * (h.yield / 100);
    });
    const monthly = annual / 12;
    const quarter = annual / 4;
    annualSpan.textContent = `$${annual.toFixed(2).toLocaleString()}`;
    monthlySpan.textContent = `$${monthly.toFixed(2).toLocaleString()}`;
    quarterSpan.textContent = `$${quarter.toFixed(2).toLocaleString()}`;
    weightedYieldSpan.textContent = (weightedYield * 100).toFixed(2) + '%';
    // Update summary bar
    summaryAnnual.textContent = annualSpan.textContent;
    summaryQuarter.textContent = quarterSpan.textContent;
    summaryMonthly.textContent = monthlySpan.textContent;
    summaryPortfolio.textContent = `$${Number(portfolio).toLocaleString()}`;
    // Calculate weighted average expense ratio and annual fees
    let weightedExpense = 0;
    holdings.forEach(h => {
      const weight = parseFloat(h.weight) / 100;
      weightedExpense += weight * (h.expense || 0);
    });
    const annualFees = portfolio * (weightedExpense / 100);
    const summaryAnnualFees = document.getElementById('summaryAnnualFees');
    if (summaryAnnualFees) {
      summaryAnnualFees.textContent = `$${annualFees.toFixed(2).toLocaleString()}`;
    }

    // Show the portfolio value in the growth section and refresh the growth chart
    const growthInitialDisplay = document.getElementById('growthInitialDisplay');
    if (growthInitialDisplay) {
      growthInitialDisplay.textContent = `$${Number(portfolio).toLocaleString()}`;
    }
    updateGrowthChart();
    // If detailed breakdown visible update it
    if (detailedIncomeDiv.style.display !== 'none') {
      renderDetailedIncome(portfolio);
    }
    // If class income breakdown visible update it
    const classDiv = document.getElementById('classIncomeBreakdown');
    if (classDiv.style.display !== 'none') {
      renderClassIncome(portfolio);
    }
  }

  // Render per holding income breakdown
  function renderDetailedIncome(portfolio) {
    let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:0.75rem;">';
    holdings.forEach(h => {
      const weight = parseFloat(h.weight) / 100;
      const val = portfolio * weight;
      const annualIncome = val * (h.yield / 100);
      const monthlyIncome = annualIncome / 12;
      const quarterlyIncome = annualIncome / 4;
      html += `<div style="background: var(--hover-bg); border:1px solid var(--border-colour); padding:0.75rem; border-radius:8px; font-size:1rem;">
        <strong style="font-size:1.1em;">${h.ticker}</strong><br>
        <span style="color:var(--muted-text);">Holding Value:</span> <span style="font-weight:600;">$${val.toFixed(2).toLocaleString()}</span><br>
        <span style="color:var(--muted-text);">Annual Income:</span> <span style="color: var(--accent); font-weight:600;">$${annualIncome.toFixed(2).toLocaleString()}</span><br>
        <span style="color:var(--muted-text);">Quarterly:</span> <span style="font-weight:600;">$${quarterlyIncome.toFixed(2).toLocaleString()}</span><br>
        <span style="color:var(--muted-text);">Monthly:</span> <span style="font-weight:600;">$${monthlyIncome.toFixed(2).toLocaleString()}</span>
      </div>`;
    });
    html += '</div>';
    detailedIncomeDiv.innerHTML = html;
  }

  // Render per asset class income breakdown
  function renderClassIncome(portfolio) {
    const classTotals = {};
    holdings.forEach(h => {
      const weight = parseFloat(h.weight) / 100;
      const value = portfolio * weight;
      const annual = value * (h.yield / 100);
      if (!classTotals[h.class]) {
        classTotals[h.class] = { value: 0, annual: 0 };
      }
      classTotals[h.class].value += value;
      classTotals[h.class].annual += annual;
    });
    let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.75rem;">';
    Object.keys(classTotals).forEach(cls => {
      const obj = classTotals[cls];
      const annual = obj.annual;
      const quarterly = annual / 4;
      const monthly = annual / 12;
      html += `<div style="background: var(--hover-bg); border:1px solid var(--border-colour); padding:0.75rem; border-radius:8px; font-size:1rem;">
        <strong style="font-size:1.1em;">${cls}</strong><br>
        <span style="color:var(--muted-text);">Total Value:</span> <span style="font-weight:600;">$${obj.value.toFixed(2).toLocaleString()}</span><br>
        <span style="color:var(--muted-text);">Annual Income:</span> <span style="color: var(--accent); font-weight:600;">$${annual.toFixed(2).toLocaleString()}</span><br>
        <span style="color:var(--muted-text);">Quarterly:</span> <span style="font-weight:600;">$${quarterly.toFixed(2).toLocaleString()}</span><br>
        <span style="color:var(--muted-text);">Monthly:</span> <span style="font-weight:600;">$${monthly.toFixed(2).toLocaleString()}</span>
      </div>`;
    });
    html += '</div>';
    document.getElementById('classIncomeBreakdown').innerHTML = html;
  }
  // --- Reset All Data Logic (with custom alert modal) ---
  document.addEventListener('DOMContentLoaded', () => {
    const resetBtn = document.getElementById('resetAllBtn');
    if (resetBtn) {
      resetBtn.addEventListener('click', function() {
        showCustomAlert('Are you sure you want to reset all data? This will wipe your portfolio and settings.', function() {
          localStorage.removeItem(LS_KEY);
          localStorage.removeItem(DRIP_KEY);
          setTimeout(function() { location.reload(); }, 300);
        });
      });
    }
  });

  accountSlider.addEventListener('input', updateIncome);

  document.getElementById('toggleDetailedIncome').addEventListener('click', function() {
    if (detailedIncomeDiv.style.display === 'none') {
      detailedIncomeDiv.style.display = 'block';
      this.textContent = 'Hide Per-Holding Breakdown';
      renderDetailedIncome(parseFloat(accountSlider.value) || 0);
    } else {
      detailedIncomeDiv.style.display = 'none';
      this.textContent = 'Show Per-Holding Breakdown';
    }
  });

  // Toggle asset-class income breakdown
  document.getElementById('toggleClassIncome').addEventListener('click', function() {
    const classDiv = document.getElementById('classIncomeBreakdown');
    if (classDiv.style.display === 'none') {
      classDiv.style.display = 'block';
      this.textContent = 'Hide Asset‑Class Income';
      renderClassIncome(parseFloat(accountSlider.value) || 0);
    } else {
      classDiv.style.display = 'none';
      this.textContent = 'Show Asset‑Class Income';
    }
  });

  // Growth projection calculations
  function calculateGrowthProjection(initial, contribAmount, years, includeDrip, frequency = 'yearly') {
  const values = [];
  let balance = initial;
  let totalContributed = initial;

  // Weighted averages for average annual growth rate and yield
  let weightedCAGR = 0;
  let weightedYield = 0;
  holdings.forEach(h => {
    const w = parseFloat(h.weight) / 100;
    weightedCAGR += w * (parseFloat(h.cagr) || 0) / 100;
    // Convert percent to decimal for calculation
    if (includeDrip && h.drip) weightedYield += w * (h.yield / 100);
  });

  const effectiveRate = weightedCAGR + weightedYield;

  // Rule of 72 estimate (years to double)
  // Only update the display if called from renderGrowthChart
  if (typeof window.updateRuleOf72Estimate === 'function') {
    window.updateRuleOf72Estimate(effectiveRate, includeDrip);
  }

  // Convert contribution to yearly total based on frequency
  const contribPerYear = {
    yearly: contribAmount,
    monthly: contribAmount * 12,
    biweekly: contribAmount * 26,
    weekly: contribAmount * 52
  }[frequency] || contribAmount;

  for (let i = 1; i <= years; i++) {
    balance += contribPerYear;
    totalContributed += contribPerYear;
    balance *= (1 + effectiveRate);
    values.push({ year: i, value: parseFloat(balance.toFixed(2)), contributed: totalContributed });
  }
  // Return both values and effectiveRate
  return { values, effectiveRate };
}


  function getChartColors() {
  // Use body.classList to detect light/dark mode
  const style = getComputedStyle(document.body);
  return {
    grid: style.getPropertyValue('--border-colour').trim() || '#324877',
    legend: style.getPropertyValue('--text-colour').trim() || '#e4e8f2',
    axis: style.getPropertyValue('--text-colour').trim() || '#e4e8f2',
    tooltipBg: style.getPropertyValue('--tooltip-bg').trim() || 'rgba(14, 21, 37, 0.95)',
    tooltipTitle: style.getPropertyValue('--accent').trim() || '#4cc9f0',
    tooltipBody: style.getPropertyValue('--text-colour').trim() || '#e4e8f2',
    tooltipBorder: style.getPropertyValue('--accent').trim() || '#4cc9f0'
  };
}

  function renderGrowthChart() {
    // Use the current portfolio value from the income slider as the initial amount
    const initial = parseFloat(accountSlider.value) || 0;
    const contrib = parseFloat(document.getElementById('growthContribution').value) || 0;
    const years = parseInt(document.getElementById('growthYears').value) || 0;
    const freq = document.getElementById('growthFrequency').value;
  const priceGrowthObj = calculateGrowthProjection(initial, contrib, years, false, freq);
  const totalGrowthObj = calculateGrowthProjection(initial, contrib, years, true, freq);

  // Rule of 72 for both scenarios
  window.updateRuleOf72Estimate = function(effectiveRate, withDrip) {
  const ruleOf72NoDrip = priceGrowthObj.effectiveRate > 0 ? (72 / (priceGrowthObj.effectiveRate * 100)).toFixed(1) : 'N/A';
  const ruleOf72WithDrip = totalGrowthObj.effectiveRate > 0 ? (72 / (totalGrowthObj.effectiveRate * 100)).toFixed(1) : 'N/A';
  const noDripText = `<span style='color:#fdd000;'>No DRIP:</span> <b>${ruleOf72NoDrip} yrs</b> <span style='color:#fdd000;'>(${(priceGrowthObj.effectiveRate*100).toFixed(2)}%)</span>`;
  const withDripText = `<span style='color:#4cc9f0;'>With DRIP:</span> <b>${ruleOf72WithDrip} yrs</b> <span style='color:#4cc9f0;'>(${(totalGrowthObj.effectiveRate*100).toFixed(2)}%)</span>`;
  document.getElementById('ruleOf72Estimate').innerHTML = `
    <span style='font-weight:600; position:relative; cursor:help;' class='rule72-tooltip'>
      Rule of 72
      <span class='tooltip tooltip-text' style="display:none; left:0; top:1.8em; min-width:320px; max-width:420px; white-space:normal;">
        <b>Rule of 72</b> is a simple way to estimate how many years it will take for an investment to double, given a fixed annual rate of return. Divide 72 by the annual rate (%).
      </span>
    </span>: ${noDripText} &nbsp;|&nbsp; ${withDripText}`;
  // Add tooltip hover logic (match global tooltip behavior)
  const rule72El = document.querySelector('.rule72-tooltip');
  if (rule72El) {
    const tip = rule72El.querySelector('.tooltip-text');
    rule72El.addEventListener('mouseenter', function() {
      if (tip) { tip.style.display = 'block'; tip.style.opacity = '1'; }
    });
    rule72El.addEventListener('mouseleave', function() {
      if (tip) { tip.style.display = 'none'; tip.style.opacity = '0'; }
    });
  }
  };
  window.updateRuleOf72Estimate();

  const labels = priceGrowthObj.values.map(d => `Year ${d.year}`);
  const priceData = priceGrowthObj.values.map(d => d.value);
  const totalData = totalGrowthObj.values.map(d => d.value);
  // Extract contributed amounts (from either object, they're the same)
  const contributedData = totalGrowthObj.values.map(d => d.contributed);

  const ctx = document.getElementById('growthChart').getContext('2d');
  const weightedAnnualReturnNoDrip = priceGrowthObj.effectiveRate * 100; // percent
  const weightedAnnualReturnWithDrip = totalGrowthObj.effectiveRate * 100; // percent
  document.getElementById('weightedAnnualReturnNoDrip').textContent = weightedAnnualReturnNoDrip.toFixed(2) + "%";
  document.getElementById('weightedAnnualReturnWithDrip').textContent = weightedAnnualReturnWithDrip.toFixed(2) + "%";

  // Get theme-aware colors
  const chartColors = getChartColors();

  if (growthChartInstance) growthChartInstance.destroy();
  growthChartInstance = new Chart(ctx, {
      type: chartType,
      data: {
        labels: labels,
        datasets: [
          // Move "Total Contributed" to the first dataset
          {
            label: 'Total Contributed',
            data: contributedData,
            backgroundColor: 'transparent',
            borderColor: 'rgba(150,150,150,0.7)',
            borderWidth: 2,
            borderDash: [6, 6],
            fill: false,
            tension: 0,
            pointBackgroundColor: 'rgba(150,150,150,0.7)',
            pointRadius: 0,
            pointHoverRadius: 4
          },
          {
            label: 'Price Growth (Avg Annual Growth Only)',
            data: priceData,
            backgroundColor: chartType === 'bar' ? 'rgba(253, 208, 0, 0.6)' : 'transparent',
            borderColor: 'rgba(253, 208, 0, 1)',
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointBackgroundColor: chartType === 'bar' ? 'rgba(253, 208, 0, 0.6)' : 'rgba(253, 208, 0, 1)',
            pointRadius: chartType === 'bar' ? 0 : 3,
            pointHoverRadius: chartType === 'bar' ? 0 : 5
          },
          {
            label: 'Total Growth (Avg Annual Growth + DRIP)',
            data: totalData,
            backgroundColor: chartType === 'bar' ? 'rgba(76, 201, 240, 0.6)' : 'transparent',
            borderColor: 'rgba(76, 201, 240, 1)',
            borderWidth: 2,
            fill: false,
            tension: 0.3,
            pointBackgroundColor: chartType === 'bar' ? 'rgba(76, 201, 240, 0.6)' : 'rgba(76, 201, 240, 1)',
            pointRadius: chartType === 'bar' ? 0 : 3,
            pointHoverRadius: chartType === 'bar' ? 0 : 5
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index', intersect: false
        },
        plugins: {
          tooltip: {
            backgroundColor: chartColors.tooltipBg,
            titleColor: chartColors.tooltipTitle,
            bodyColor: chartColors.tooltipBody,
            borderColor: chartColors.tooltipBorder,
            borderWidth: 1,
            cornerRadius: 8,
            padding: 10,
            titleFont: { family: "'Inter', sans-serif", weight: '600', size: 14 },
            bodyFont: { family: "'Inter', sans-serif", weight: '400', size: 13 },
            callbacks: {
              label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toLocaleString()}`
            }
          },
          legend: {
            labels: { color: chartColors.legend }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: value => `$${value.toLocaleString()}`,
              color: chartColors.axis
            },
            grid: { color: chartColors.grid }
          },
          x: {
            ticks: { color: chartColors.axis },
            grid: { color: chartColors.grid }
          }
        }
      }
    });
    // Add button to open breakdown table modal
  // Button is now in the DOM next to the toggleGrowthChart button
  const breakdownBtn = document.getElementById('showGrowthBreakdownBtn');
    // Modal for breakdown table
    let modal = document.getElementById('growthBreakdownModal');
    if (!modal) {
      modal = document.createElement('div');
      modal.id = 'growthBreakdownModal';
      modal.style.position = 'fixed';
      modal.style.top = '0';
      modal.style.left = '0';
      modal.style.width = '100vw';
      modal.style.height = '100vh';
      modal.style.background = 'rgba(0,0,0,0.45)';
      modal.style.display = 'none';
      modal.style.zIndex = '99999';
  modal.innerHTML = `<div class="modal-fade" id="growthBreakdownModalInner" style="position:relative;max-width:820px;margin:5vh auto;background:var(--card-bg);border-radius:14px;padding:2rem;box-shadow:0 16px 48px rgba(0,0,0,0.30);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;">
          <button id="closeGrowthBreakdownModal" class="btn">Close</button>
          <button id="exportBreakdownCSV" class="btn" style="margin-left:auto;">Export Breakdown as CSV</button>
        </div>
        <div class="growth-breakdown-scroll" style="width:100%; max-height:80vh; min-height:60vh; overflow-y:auto; padding-top:0;">
          <div id="growthBreakdownTableContent"></div>
        </div>
      </div>`;
      document.body.appendChild(modal);
    }
    // Stacked table HTML (Without DRIP and With DRIP rows for each year)
    let tableHtml = `<table style="width:100%;border-collapse:collapse;margin-top:1rem;table-layout:fixed;">
      <thead>
        <tr style="background:var(--table-header-bg);color:var(--table-header-text);">
          <th class="sticky-th">Year</th>
          <th class="sticky-th">Type</th>
          <th class="sticky-th">Start Value</th>
          <th class="sticky-th">Income</th>
          <th class="sticky-th">Contribution</th>
          <th class="sticky-th">End Value</th>
        </tr>
      </thead>
      <tbody>`;
    let prevNoDrip = initial;
    let weightedYieldNoDrip = 0;
    holdings.forEach(h => {
      const w = parseFloat(h.weight) / 100;
      if (!h.drip) weightedYieldNoDrip += w * (h.yield / 100);
    });
    let prevDrip = initial;
    let weightedYieldDrip = 0;
    holdings.forEach(h => {
      const w = parseFloat(h.weight) / 100;
      if (h.drip) weightedYieldDrip += w * (h.yield / 100);
    });
    for (let i = 0; i < years; i++) {
      const yearNum = i + 1;
      // Without DRIP row
      const startNoDrip = prevNoDrip;
      const incomeNoDrip = startNoDrip * weightedYieldNoDrip;
      const contribNoDrip = priceGrowthObj.values[i].contributed - (i === 0 ? initial : priceGrowthObj.values[i-1].contributed);
      const endNoDrip = priceGrowthObj.values[i].value;
      prevNoDrip = endNoDrip;
      // With DRIP row
      const startDrip = prevDrip;
      const incomeDrip = startDrip * weightedYieldDrip;
      const contribDrip = totalGrowthObj.values[i].contributed - (i === 0 ? initial : totalGrowthObj.values[i-1].contributed);
      const endDrip = totalGrowthObj.values[i].value;
      prevDrip = endDrip;
      tableHtml += `<tr style="background:${yearNum%2===0?'var(--card-bg)':'var(--hover-bg)'};">
        <td rowspan="2">${yearNum}</td>
        <td>Without DRIP</td>
        <td>$${startNoDrip.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>$${incomeNoDrip.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>$${contribNoDrip.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>$${endNoDrip.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
      </tr>`;
      tableHtml += `<tr style="background:${yearNum%2===0?'var(--card-bg)':'var(--hover-bg)'};">
        <td>With DRIP</td>
        <td>$${startDrip.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>$${incomeDrip.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>$${contribDrip.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
        <td>$${endDrip.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
      </tr>`;
    }
    tableHtml += '</tbody></table>';
    document.getElementById('growthBreakdownTableContent').innerHTML = tableHtml;
    // Button event
    breakdownBtn.onclick = function() {
      modal.style.display = 'flex';
      setTimeout(function() {
        document.getElementById('growthBreakdownModalInner').classList.add('show');
      }, 10);
      // Attach exportBreakdownCSV event listener after modal and button are rendered
      const exportBtn = document.getElementById('exportBreakdownCSV');
      if (exportBtn) {
        exportBtn.onclick = function() {
          const table = document.getElementById('growthBreakdownTableContent').querySelector('table');
          if (!table) { showCustomAlert('Please open the Yearly Breakdown Table first.'); return; }
          const rows = [];
          // Get header
          const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());
          rows.push(headers);
          // Get all rows
          Array.from(table.querySelectorAll('tbody tr')).forEach(tr => {
            const row = Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
            rows.push(row);
          });
          downloadCSV('yearly_breakdown.csv', rows);
        };
      }
      // Attach close event
      const closeBtn = document.getElementById('closeGrowthBreakdownModal');
      if (closeBtn) {
        closeBtn.onclick = function() {
          document.getElementById('growthBreakdownModalInner').classList.remove('show');
          setTimeout(function() {
            modal.style.display = 'none';
          }, 450);
        };
      }
      // Click outside to close
      modal.onclick = function(e) {
        if (e.target === modal) {
          document.getElementById('growthBreakdownModalInner').classList.remove('show');
          setTimeout(function() {
            modal.style.display = 'none';
          }, 450);
        }
      };
    };
  }

  function updateGrowthChart() {
    renderGrowthChart();
  }

  document.getElementById('growthContribution').addEventListener('input', updateGrowthChart);
  document.getElementById('growthFrequency').addEventListener('change', updateGrowthChart);
  document.getElementById('growthYears').addEventListener('input', updateGrowthChart);
  document.getElementById('toggleGrowthChart').addEventListener('click', () => {
    chartType = chartType === 'bar' ? 'line' : 'bar';
    document.getElementById('toggleGrowthChart').textContent = chartType === 'bar' ? 'Switch to Line Chart' : 'Switch to Bar Chart';
    updateGrowthChart();
  });

  // Handle holdings view toggle between table and pie chart
  document.getElementById('toggleHoldingsView').addEventListener('click', function() {
    const tableBody = document.getElementById('holdingsBody');
    const chartContainer = document.getElementById('holdingsChartContainer');
    if (chartContainer.style.display === 'none' || chartContainer.style.display === '') {
      // Show chart, hide table
      chartContainer.style.display = 'block';
      document.querySelector('#holdings tbody').style.display = 'none';
      this.textContent = 'Switch to Table View';
      renderHoldingsPieChart();
    } else {
      chartContainer.style.display = 'none';
      document.querySelector('#holdings tbody').style.display = 'table-row-group';
      this.textContent = 'Switch to Pie Chart';
    }
  });

  function renderHoldingsPieChart() {
    const ctx = document.getElementById('holdingsChart').getContext('2d');
    const labels = holdings.map(h => h.ticker);
    const data = holdings.map(h => parseFloat(h.weight));
    // Use accent color and harmonious variants for pie slices
  const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();
  const cardBg = getComputedStyle(document.documentElement).getPropertyValue('--card-bg').trim();
  // Detect light mode
  const isLightMode = document.body.classList.contains('light-mode');
  // Set pie chart background and text color for readability
  const pieBg = isLightMode ? '#fff' : cardBg;
  const pieText = isLightMode ? '#222' : getComputedStyle(document.documentElement).getPropertyValue('--text-colour').trim();
    // Generate harmonious colors based on accent
    function generateColors(base, count) {
      // Use accent, then rotate hue for others
      const accentHSL = base.startsWith('rgb') ? rgbToHsl(base) : hexToHsl(base);
      return Array.from({length: count}, (_, i) => {
        const hue = (accentHSL[0] + i * (360 / count)) % 360;
        let sat = accentHSL[1];
        let light = accentHSL[2];
        if (isLightMode) {
          // Make colors more pastel in light mode
          sat = Math.max(40, Math.min(70, sat));
          light = Math.max(70, Math.min(90, light + 20));
        }
        return `hsl(${hue}, ${sat}%, ${light}%)`;
      });
    }
    // Helper: convert rgb/hex to hsl
    function rgbToHsl(rgb) {
      let [r, g, b] = rgb.match(/\d+/g).map(Number);
      r /= 255; g /= 255; b /= 255;
      const max = Math.max(r, g, b), min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;
      if (max === min) { h = s = 0; }
      else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
          case r: h = (g - b) / d + (g < b ? 6 : 0); break;
          case g: h = (b - r) / d + 2; break;
          case b: h = (r - g) / d + 4; break;
        }
        h *= 60;
      }
      return [Math.round(h), Math.round(s * 100), Math.round(l * 100)];
    }
    function hexToHsl(hex) {
      let c = hex.replace('#','');
      if (c.length === 3) c = c.split('').map(x=>x+x).join('');
      const r = parseInt(c.substring(0,2),16), g = parseInt(c.substring(2,4),16), b = parseInt(c.substring(4,6),16);
      return rgbToHsl(`rgb(${r},${g},${b})`);
    }
    const colours = generateColors(accent, labels.length);
    if (holdingsChart) holdingsChart.destroy();
    holdingsChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: labels,
        datasets: [
          {
            data: data,
            backgroundColor: colours,
            borderColor: cardBg,
            borderWidth: 3,
            hoverOffset: 8,
          }
        ]
      },
      options: {
        plugins: {
          legend: {
            labels: {
              color: pieText,
              font: { family: "'Inter', sans-serif", size: 14, weight: '600' }
            }
          },
          tooltip: {
            backgroundColor: isLightMode ? '#fff' : getComputedStyle(document.documentElement).getPropertyValue('--tooltip-bg').trim(),
            titleColor: accent,
            bodyColor: pieText,
            borderColor: accent,
            borderWidth: 1,
            cornerRadius: 10,
            padding: 12,
            titleFont: { family: "'Inter', sans-serif", weight: '700', size: 15 },
            bodyFont: { family: "'Inter', sans-serif", weight: '400', size: 13 },
            callbacks: {
              label: ctx => `${ctx.label}: ${ctx.parsed}%`
            }
          }
        },
        layout: {
          padding: 0
        },
        backgroundColor: pieBg
      }
    });
    // Add matching style to chart container
    const chartDiv = document.getElementById('holdingsChartContainer');
  chartDiv.style.background = pieBg;
  chartDiv.style.borderRadius = '16px';
  chartDiv.style.boxShadow = isLightMode ? '0 4px 18px rgba(0,0,0,0.10)' : '0 4px 18px rgba(0,0,0,0.25)';
  chartDiv.style.padding = '16px';
  }
  
  //Custom Alertbox (now supports optional callback)
  function showCustomAlert(message, onConfirm) {
    const alertBox = document.getElementById('customAlert');
    const alertMessage = document.getElementById('customAlertMessage');
    const yesBtn = document.getElementById('customAlertYes');
    const noBtn = document.getElementById('customAlertNo');
    const okayBtn = document.getElementById('customAlertOkay');

    alertMessage.textContent = message;
      alertBox.style.display = 'flex';
      setTimeout(function() {
        alertBox.classList.add('show');
      }, 10);

    // Hide/show buttons based on whether confirmation is needed
    if (typeof onConfirm === 'function') {
      yesBtn.style.display = '';
      noBtn.style.display = '';
      okayBtn.style.display = 'none';
      yesBtn.onclick = () => {
          alertBox.classList.remove('show');
          setTimeout(function() {
            alertBox.style.display = 'none';
          }, 450);
        onConfirm();
      };
      noBtn.onclick = () => {
          alertBox.classList.remove('show');
          setTimeout(function() {
            alertBox.style.display = 'none';
          }, 450);
      };
      okayBtn.onclick = null;
    } else {
      yesBtn.style.display = 'none';
      noBtn.style.display = 'none';
      okayBtn.style.display = '';
      okayBtn.onclick = () => {
          alertBox.classList.remove('show');
          setTimeout(function() {
            alertBox.style.display = 'none';
          }, 450);
      };
      yesBtn.onclick = null;
      noBtn.onclick = null;
    }
  }

  // Restore fetchMetrics from v1.1.3
  let canFetch = true;
  async function fetchMetrics() {
    if (!canFetch) {
      showCustomAlert("Please wait 15 seconds between fetch requests.");
      return;
    }

    const ticker = document.getElementById('newTicker').value.trim().toUpperCase();
    if (!ticker) {
      showCustomAlert("Please enter a ticker symbol first.");
      return;
    }

    canFetch = false;
    setTimeout(() => { canFetch = true; }, 15000); // 15 sec timer

    try {
      // Use Alpha Vantage API for overview
      const url = `https://www.alphavantage.co/query?function=OVERVIEW&symbol=${ticker}&apikey=${API_KEY}`;
      const res = await fetch(url);
      const data = await res.json();

      if (data.Note) {
        showCustomAlert("API limit reached. Please wait a minute before trying again.");
        return;
      }

      if (!data || !data.Symbol) {
        showCustomAlert("No data found for ticker: " + ticker);
        return;
      }

      // Fill form fields if available
      document.getElementById('newName').value = data.Name || ticker;
      // AssetType can be 'Stock', 'ETF', 'Mutual Fund', etc.
      document.getElementById('newClass').value = data.AssetType || '';
      // For ETFs and mutual funds, DividendYield may be missing; try other fields
      let yieldVal = '';
      if (data.DividendYield) {
        yieldVal = (parseFloat(data.DividendYield) * 100).toFixed(2);
      } else if (data.TrailingAnnualDividendYield) {
        yieldVal = (parseFloat(data.TrailingAnnualDividendYield) * 100).toFixed(2);
      }
      document.getElementById('newYield').value = yieldVal;
      // For growth, fallback to FiveYearAverageDividendYield or other available fields
      let cagrVal = '';
      if (data.FiveYearAverageDividendYield) {
        cagrVal = parseFloat(data.FiveYearAverageDividendYield).toFixed(2);
      } else if (data.AnnualizedReturn) {
        cagrVal = parseFloat(data.AnnualizedReturn).toFixed(2);
      }
      document.getElementById('newCAGR').value = cagrVal;
      document.getElementById('newExpense').value = data.ExpenseRatio ? parseFloat(data.ExpenseRatio).toFixed(2) : '';
      // Optionally set schedule based on dividend frequency or payment frequency
      if (data.DividendDate) {
        document.getElementById('newSchedule').value = 'quarterly'; // Most US stocks/ETFs pay quarterly
      } else if (data.PaymentFrequency) {
        document.getElementById('newSchedule').value = data.PaymentFrequency.toLowerCase();
      }
    } catch (err) {
      showCustomAlert("Error fetching data: " + err.message);
    }
  }


  // Add holding manually
  document.getElementById('addHolding').addEventListener('click', () => {
  const name = document.getElementById('newName').value.trim();
  const ticker = document.getElementById('newTicker').value.trim().toUpperCase();
  const cls = document.getElementById('newClass').value.trim();
  const weightRaw = document.getElementById('newWeight').value;
  const yieldRaw = document.getElementById('newYield').value;
  const cagrRaw = document.getElementById('newCAGR').value;
  const expenseRaw = document.getElementById('newExpense').value;
  const schedule = document.getElementById('newSchedule').value;

  if (!ticker) {
    showCustomAlert('Please enter at least a ticker symbol.');
    return;
  }

  const weight = isNaN(parseFloat(weightRaw)) ? 0 : parseFloat(weightRaw);
  const yieldVal = isNaN(parseFloat(yieldRaw)) ? 0 : parseFloat(yieldRaw);
  const cagr = isNaN(parseFloat(cagrRaw)) ? 0 : parseFloat(cagrRaw);
  const expense = isNaN(parseFloat(expenseRaw)) ? 0 : parseFloat(expenseRaw);

  // Validate & Enforce Maximimum Weight
  const totalWeight = holdings.reduce((sum, h, i) => {
    return sum + (i === editingIndex ? 0 : parseFloat(h.weight) || 0);
  }, 0);

  const newTotal = totalWeight + weight;

  if (newTotal > 100) {
    showCustomAlert(`Total portfolio weight cannot exceed 100%. You are trying to set it to ${newTotal.toFixed(2)}%.`);
    return;
  }

  // Use default DRIP state
  let defaultDrip = true;
  try {
    defaultDrip = loadDefaultDrip();
  } catch {}
  const holding = {
    name: name || ticker,
    ticker: ticker,
    class: cls || 'Uncategorised',
    weight: weight,
    yield: yieldVal,
    cagr: cagr,
    expense: expense,
    schedule: schedule,
    drip: defaultDrip
  };

  // existing logic continues...
    if (editingIndex >= 0) {
      // Update existing holding while preserving DRIP toggle
      const original = holdings[editingIndex];
      holdings[editingIndex] = {
        ...original,
        name: name || ticker,
        ticker: ticker,
        class: cls || 'Uncategorised',
        weight: weight,
        yield: yieldVal,
        cagr: cagr,
        expense: expense,
        schedule: schedule
      };
      editingIndex = -1;
      document.getElementById('addHolding').textContent = 'Add';
    } else {
      holdings.push(holding);
    }
    saveHoldings();
    // Clear form inputs
    document.getElementById('newName').value = '';
    document.getElementById('newTicker').value = '';
    document.getElementById('newClass').value = '';
    document.getElementById('newWeight').value = '';
    document.getElementById('newYield').value = '';
    document.getElementById('newCAGR').value = '';
    document.getElementById('newExpense').value = '';
    renderHoldingsTable();
    updateCategoryWeights();
    updateContributionAllocation();
    updateIncome();
    updateGrowthChart();
  });
  contributionInput.addEventListener('input', function() { saveHoldings(); });
  accountSlider.addEventListener('input', function() { saveHoldings(); });
  document.getElementById('growthContribution').addEventListener('input', function() { saveHoldings(); });
  document.getElementById('growthFrequency').addEventListener('change', function() { saveHoldings(); });
  document.getElementById('growthYears').addEventListener('input', function() { saveHoldings(); });

  // Import/export configuration for ALL portfolios
  document.getElementById('exportBtn').addEventListener('click', () => {
    const portfolios = getPortfolios();
    const activePortfolio = getActivePortfolioName();
    const exportData = {
      portfolios,
      activePortfolio
    };
    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'portfolio_config.json';
    a.click();
    URL.revokeObjectURL(url);
  });
  document.getElementById('importBtn').addEventListener('click', () => {
    document.getElementById('importFile').click();
  });
  document.getElementById('importFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
      try {
        const imported = JSON.parse(evt.target.result);
        if (imported && imported.portfolios && typeof imported.portfolios === 'object') {
          savePortfolios(imported.portfolios);
          setActivePortfolioName(imported.activePortfolio || Object.keys(imported.portfolios)[0]);
          holdings = imported.portfolios[getActivePortfolioName()] || [];
          renderHoldingsTable();
          updateCategoryWeights();
          updateContributionAllocation();
          updateIncome();
          updateGrowthChart();
          updatePortfolioDropdown();
          showCustomAlert('All portfolios imported successfully.');
        } else {
          showCustomAlert('Invalid configuration file.');
        }
      } catch (err) {
        showCustomAlert('Failed to parse configuration.');
      }
    };
    reader.readAsText(file);
  });

  // Theme toggle
  document.getElementById('themeToggle').addEventListener('click', () => {
    const isLight = document.body.classList.toggle('light-mode');
    localStorage.setItem('themeMode', isLight ? 'light' : 'dark');
    updateGrowthChart(); // Add this line to refresh chart colors
    // If pie chart is visible, update it for theme
    const chartContainer = document.getElementById('holdingsChartContainer');
    if (chartContainer && chartContainer.style.display === 'block') {
      renderHoldingsPieChart();
    }
  });
  
  // Sort Indicators
  let currentSort = { key: null, asc: true };

function updateSortIndicators() {
  document.querySelectorAll('#holdings thead th[data-sort]').forEach(th => {
    const key = th.dataset.sort;
    const span = th.querySelector('span');
    if (!span) return;

    const label = span.textContent.replace(/[\u25B2\u25BC]/g, '').trim();

    if (key === currentSort.key) {
      span.textContent = label + (currentSort.asc ? ' ▲' : ' ▼');
    } else {
      span.textContent = label;
    }
  });
}


  // Initialise after DOM ready
  document.addEventListener('DOMContentLoaded', () => {
    // Restore theme from localStorage
    const savedTheme = localStorage.getItem('themeMode');
    if (savedTheme === 'light') {
      document.body.classList.add('light-mode');
    } else {
      document.body.classList.remove('light-mode');
    }
  document.querySelectorAll('#holdings thead th[data-sort]').forEach(th => {
  th.style.cursor = 'pointer';
  th.addEventListener('click', () => {
    const key = th.dataset.sort;
    const isAsc = currentSort.key === key ? !currentSort.asc : true;
    currentSort = { key, asc: isAsc };
	
    holdings.sort((a, b) => {
      const valA = a[key];
      const valB = b[key];

      if (typeof valA === 'string') {
        return isAsc
          ? valA.localeCompare(valB)
          : valB.localeCompare(valA);
      } else {
        return isAsc
          ? parseFloat(valA) - parseFloat(valB)
          : parseFloat(valB) - parseFloat(valA);
      }
    });

    renderHoldingsTable();
    updateSortIndicators();
  });
});

document.getElementById('fetchMetrics').addEventListener('click', fetchMetrics);


// Settings dropdown logic
const settingsBtn = document.getElementById('settingsDropdownBtn');
const settingsDropdown = document.getElementById('settingsDropdown');
document.addEventListener('click', function(e) {
  if (settingsBtn.contains(e.target)) {
    settingsDropdown.style.display = settingsDropdown.style.display === 'block' ? 'none' : 'block';
  } else if (!settingsDropdown.contains(e.target)) {
    settingsDropdown.style.display = 'none';
  }
});


    // On page load, always use the active portfolio from localStorage
    const activePortfolio = getActivePortfolioName();
    const portfolios = getPortfolios();
    if (portfolios[activePortfolio]) {
      holdings = portfolios[activePortfolio];
    } else {
      holdings = [];
    }
    renderHoldingsTable();
    updateCategoryWeights();
    updateContributionAllocation();
    updateIncome();
    updateGrowthChart();
    updatePortfolioSummary();
    // Default slider value
    accountSlider.value = 0;
    updateIncome();
  });
  // ...existing code...
  // Stock Research Modal logic
  document.addEventListener('DOMContentLoaded', function() {
    var researchBtn = document.getElementById('stockResearchBtn');
    var researchModal = document.getElementById('stockResearchModal');
    var closeResearch = document.getElementById('closeStockResearch');
    if (researchBtn && researchModal && closeResearch) {
      researchBtn.addEventListener('click', function() {
        researchModal.style.display = 'flex';
      });
      closeResearch.addEventListener('click', function() {
        researchModal.style.display = 'none';
      });
      researchModal.addEventListener('click', function(e) {
        if (e.target === researchModal) researchModal.style.display = 'none';
      });
    }
  });
  </script>
  
  <!-- Custom warning modal -->
<div id="customAlert" style="display:none;">
  <div id="customAlertBackdrop"></div>
  <div id="customAlertBox">
    <h3>⚠ Warning</h3>
    <p id="customAlertMessage"></p>
    <div style="display:flex;justify-content:center;gap:1rem;margin-top:1rem;">
      <button id="customAlertYes" class="btn" style="background-color:var(--accent);color:var(--card-bg);display:none;">Yes</button>
      <button id="customAlertNo" class="btn" style="background-color:var(--card-bg);color:var(--accent);border-color:var(--accent);display:none;">No</button>
      <button id="customAlertOkay" class="btn" style="background-color:var(--accent);color:var(--card-bg);display:none;">Okay</button>
    </div>
  </div>
</div>

</body>
</html>
